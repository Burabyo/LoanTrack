/**
 * @fileoverview Firestore Security Rules for the Loan Management Application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles,
 * client-ownership for client data, and restricts access to cash flow and cashier performance
 * data. Admin roles are supported via a dedicated `roles_admin` collection.
 * Authorization Independence is a core tenet, avoiding `get()` calls wherever possible
 * through data denormalization.
 *
 * Data Structure:
 * - /clients/{clientId}: Stores client profiles.
 * - /clients/{clientId}/loans/{loanId}: Stores loan data for each client.
 * - /clients/{clientId}/loans/{loanId}/payments/{paymentId}: Stores payment data for each loan.
 * - /cash_flow/{cashFlowId}: Stores cash flow transactions.
 * - /cashier_performance/{cashierPerformanceId}: Stores cashier performance data.
 * - /users/{userId}: Stores user profiles.
 * - /roles_admin/{userId}: Stores admin user IDs.  Existence implies admin role.
 *
 * Key Security Decisions:
 * - Clients and loans can be created, read, updated, and deleted by their owners.
 * - Cash flow and cashier performance data is restricted for now.
 * - User listing is disallowed for privacy.
 * - Admin users, as defined in the `roles_admin` collection, are implicitly trusted.
 *
 * Denormalization for Authorization:
 * - Loan documents include the `clientId` to allow rules at /loans/{loanId} to validate
 *   client ownership without needing to `get()` the client document.
 * - Payment documents include `clientId` and `loanId` for similar reasons.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is from an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource (userId).
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an existing owner of the resource.
     *               Combines ownership check with existence check for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

     /**
      * @description Checks if the user has admin role.
      */
    function isAdmin() {
      return exists(/databases/(database)/documents/roles_admin/$(request.auth.uid));
    }


    /**
     * @description Defines rules for the /clients/{clientId} collection.
     * @path /clients/{clientId}
     * @allow (create) User 'user_abc' can create a client document if their auth UID matches the clientId.
     * @deny (create) User 'user_def' cannot create a client document with clientId 'user_abc'.
     * @allow (get, list) Any authenticated user can read client data.
     * @allow (update, delete) User 'user_abc' can update/delete their client document.
     * @deny (update, delete) User 'user_def' cannot update/delete client document 'user_abc'.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /clients/{clientId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == clientId;
      allow update: if isExistingOwner(clientId);
      allow delete: if isExistingOwner(clientId);
    }

    /**
     * @description Defines rules for the /clients/{clientId}/loans/{loanId} collection.
     * @path /clients/{clientId}/loans/{loanId}
     * @allow (create) User 'user_abc' can create a loan document under their client document.
     * @deny (create) User 'user_def' cannot create a loan document under client 'user_abc'.
     * @allow (get, list) Any authenticated user can read loan data under a specific client.
     * @allow (update, delete) User 'user_abc' can update/delete their loan document.
     * @deny (update, delete) User 'user_def' cannot update/delete loan document under client 'user_abc'.
     * @principle Enforces client ownership for writes, allows public reads.
     */
    match /clients/{clientId}/loans/{loanId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == clientId;
      allow update: if isExistingOwner(clientId);
      allow delete: if isExistingOwner(clientId);
    }

    /**
     * @description Defines rules for the /clients/{clientId}/loans/{loanId}/payments/{paymentId} collection.
     * @path /clients/{clientId}/loans/{loanId}/payments/{paymentId}
     * @allow (create) User 'user_abc' can create a payment document under their loan document.
     * @deny (create) User 'user_def' cannot create a payment document under loan 'loan_xyz' of client 'user_abc'.
     * @allow (get, list) Any authenticated user can read payment data under a specific loan of a specific client.
     * @allow (update, delete) User 'user_abc' can update/delete their payment document.
     * @deny (update, delete) User 'user_def' cannot update/delete payment document under loan 'loan_xyz' of client 'user_abc'.
     * @principle Enforces client ownership for writes, allows public reads.
     */
    match /clients/{clientId}/loans/{loanId}/payments/{paymentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == clientId;
      allow update: if isExistingOwner(clientId);
      allow delete: if isExistingOwner(clientId);
    }

    /**
     * @description Defines rules for the /cash_flow/{cashFlowId} collection.
     * @path /cash_flow/{cashFlowId}
     * @allow (get, list) Any authenticated user can read cash flow data.
     * @deny (create, update, delete) No one can create, update, or delete cash flow data.
     * @principle Restricts all write access to cash flow data.
     */
    match /cash_flow/{cashFlowId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Defines rules for the /cashier_performance/{cashierPerformanceId} collection.
     * @path /cashier_performance/{cashierPerformanceId}
     * @allow (get, list) Any authenticated user can read cashier performance data.
     * @deny (create, update, delete) No one can create, update, or delete cashier performance data.
     * @principle Restricts all write access to cashier performance data.
     */
    match /cashier_performance/{cashierPerformanceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Defines rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User 'user_abc' can create their own user document.
     * @deny (create) User 'user_def' cannot create user document 'user_abc'.
     * @allow (get) Any authenticated user can read a user document.
     * @deny (list) User listing is not allowed.
     * @allow (update, delete) User 'user_abc' can update/delete their own user document.
     * @deny (update, delete) User 'user_def' cannot update/delete user document 'user_abc'.
     * @principle Enforces user-owned data tree.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Defines rules for the /roles_admin/{userId} collection.
      * @path /roles_admin/{userId}
      * @allow (get, list) Any authenticated user can read admin data.
      * @allow (create) Any authenticated user can create admin data.
      * @allow (update) Any authenticated user can update admin data.
      * @allow (delete) Any authenticated user can delete admin data.
      * @principle Only admin users should access this data.
      */
     match /roles_admin/{userId} {
        allow get, list: if isAdmin();
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
     }
  }
}