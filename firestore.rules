/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user data and their related financial records (loans, payments) and role-based access for administrative tasks and general access to cash flow and cashier performance data.
 *
 * Data Structure:
 * - /clients/{clientId}: Stores client information.
 * - /clients/{clientId}/loans/{loanId}: Stores loan information for each client.
 * - /clients/{clientId}/loans/{loanId}/payments/{paymentId}: Stores payment information for each loan.
 * - /cash_flow/{cashFlowId}: Stores cash flow transactions.
 * - /cashier_performance/{cashierPerformanceId}: Stores cashier performance data.
 * - /users/{userId}: Stores user information.
 * - /roles_admin/{userId}: Indicates admin users.
 *
 * Key Security Decisions:
 * - Clients can only access their own loan and payment information.
 * - Only authenticated users can create user profiles.
 * - Public read access is granted to the cash_flow and cashier_performance collections.
 * - User listing is disallowed.
 *
 * Denormalization for Authorization:
 * - The loan documents are stored under the respective clients. Each loan document denormalizes client information, avoiding `get()` calls to the parent client document for authorization.
 * - The payment documents are stored under the respective loan documents. Each payment document denormalizes loan and client information, avoiding `get()` calls to the parent loan and client documents for authorization.
 * - The cashier performance data includes the cashierId, enabling rules to validate access based solely on this denormalized data.
 *
 * Structural Segregation:
 * - Private client data (loans and payments) are stored under the respective client's document.
 * - Global roles are managed through a dedicated collection (`roles_admin`).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure client data. Only the authenticated user with matching userId can access.
     * @path /clients/{clientId}
     * @allow (create) - User with auth.uid "user123" creates a new client document with id "user123".
     * @allow (get, list, update, delete) - User with auth.uid "user123" accesses their client document with id "user123".
     * @deny (create) - User with auth.uid "user456" attempts to create a client document with id "user123".
     * @deny (get, list, update, delete) - User with auth.uid "user456" attempts to access client document with id "user123".
     * @principle Enforces document ownership for all operations.
     */
    match /clients/{clientId} {
      // Helper function to check if the authenticated user is the owner of the client document.
      function isOwner(clientId) {
        return request.auth.uid == clientId;
      }

      // Helper function to check if the authenticated user is the owner of an existing client document.
      function isExistingOwner(clientId) {
        return isOwner(clientId) && resource != null;
      }

      // Allow read access only to the owner of the client document.
      allow get: if isOwner(clientId);
      allow list: if isOwner(clientId);

      // Allow creating a client document if the user is authenticated and the client ID matches the user ID.
      allow create: if isOwner(clientId) && request.resource.data.id == request.auth.uid;

      // Allow updating and deleting a client document if the user is the owner and the document exists.
      allow update: if isExistingOwner(clientId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(clientId);
    }

    /**
     * @description Secure loan data under a client. Only the authenticated user with matching clientId can access.
     * @path /clients/{clientId}/loans/{loanId}
     * @allow (create) - User with auth.uid "user123" creates a new loan document under client "user123".
     * @allow (get, list, update, delete) - User with auth.uid "user123" accesses their loan document under client "user123".
     * @deny (create) - User with auth.uid "user456" attempts to create a loan document under client "user123".
     * @deny (get, list, update, delete) - User with auth.uid "user456" attempts to access loan document under client "user123".
     * @principle Enforces document ownership for all operations within the client's data tree.
     */
    match /clients/{clientId}/loans/{loanId} {
      // Helper function to check if the authenticated user is the owner of the loan document.
      function isOwner(clientId) {
        return request.auth.uid == clientId;
      }

      // Helper function to check if the authenticated user is the owner of an existing loan document.
      function isExistingOwner(clientId) {
        return isOwner(clientId) && resource != null;
      }

      // Allow read access only to the owner of the loan document.
      allow get: if isOwner(clientId);
      allow list: if isOwner(clientId);

      // Allow creating a loan document if the user is authenticated and the client ID matches the user ID.
      allow create: if isOwner(clientId) && request.resource.data.clientId == clientId;

      // Allow updating and deleting a loan document if the user is the owner and the document exists.
      allow update: if isExistingOwner(clientId) && request.resource.data.clientId == resource.data.clientId;
      allow delete: if isExistingOwner(clientId);
    }

    /**
     * @description Secure payment data under a loan of a client. Only the authenticated user with matching clientId can access.
     * @path /clients/{clientId}/loans/{loanId}/payments/{paymentId}
     * @allow (create) - User with auth.uid "user123" creates a new payment document under loan "loan456" of client "user123".
     * @allow (get, list, update, delete) - User with auth.uid "user123" accesses their payment document under loan "loan456" of client "user123".
     * @deny (create) - User with auth.uid "user456" attempts to create a payment document under loan "loan456" of client "user123".
     * @deny (get, list, update, delete) - User with auth.uid "user456" attempts to access payment document under loan "loan456" of client "user123".
     * @principle Enforces document ownership for all operations within the client's loan and payment data tree.
     */
    match /clients/{clientId}/loans/{loanId}/payments/{paymentId} {
      // Helper function to check if the authenticated user is the owner of the payment document.
      function isOwner(clientId) {
        return request.auth.uid == clientId;
      }

      // Helper function to check if the authenticated user is the owner of an existing payment document.
      function isExistingOwner(clientId) {
        return isOwner(clientId) && resource != null;
      }

      // Allow read access only to the owner of the payment document.
      allow get: if isOwner(clientId);
      allow list: if isOwner(clientId);

      // Allow creating a payment document if the user is authenticated and the client ID matches the user ID.
      allow create: if isOwner(clientId) && request.resource.data.loanId == loanId;

      // Allow updating and deleting a payment document if the user is the owner and the document exists.
      allow update: if isExistingOwner(clientId) && request.resource.data.loanId == resource.data.loanId;
      allow delete: if isExistingOwner(clientId);
    }

    /**
     * @description Public read access for cash flow data, restricted writes.
     * @path /cash_flow/{cashFlowId}
     * @allow (get, list) - Any user (authenticated or not) can read cash flow data.
     * @deny (create, update, delete) - No user can create, update, or delete cash flow data.
     * @principle Provides public read access while restricting write access.
     */
    match /cash_flow/{cashFlowId} {
      // Allow read access to all users.
      allow get: if true;
      allow list: if true;

      // Restrict write access to all users.
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Public read access for cashier performance data, restricted writes.
     * @path /cashier_performance/{cashierPerformanceId}
     * @allow (get, list) - Any user (authenticated or not) can read cashier performance data.
     * @deny (create, update, delete) - No user can create, update, or delete cashier performance data.
     * @principle Provides public read access while restricting write access.
     */
    match /cashier_performance/{cashierPerformanceId} {
      // Allow read access to all users.
      allow get: if true;
      allow list: if true;

      // Restrict write access to all users.
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secure user data. Only the authenticated user with matching userId can access.
     * @path /users/{userId}
     * @allow (create) - User with auth.uid "user123" creates a new user document with id "user123".
     * @allow (get, update, delete) - User with auth.uid "user123" accesses their user document with id "user123".
     * @deny (create) - User with auth.uid "user456" attempts to create a user document with id "user123".
     * @deny (get, update, delete) - User with auth.uid "user456" attempts to access user document with id "user123".
     * @deny (list) - No user can list all users.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the authenticated user is the owner of the user document.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the authenticated user is the owner of an existing user document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow read access only to the owner of the user document.
      allow get: if isOwner(userId);

      // Prevent listing of user documents.
      allow list: if false;

      // Allow creating a user document if the user is authenticated and the user ID matches the user ID.
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;

      // Allow updating and deleting a user document if the user is the owner and the document exists.
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Secure the admin users. Existence of a document indicates admin role.
      * @path /roles_admin/{userId}
      * @allow (get) - Any authenticated user can check if a user is an admin.
      * @allow (create, delete) - Only authenticated users can add or remove admins.
      * @deny (list, update) - Listing and updating is prohibited.
      * @principle Enforces role-based access control.
      */
    match /roles_admin/{userId} {
      // Helper function to check if the user is authenticated.
      function isSignedIn() {
        return request.auth != null;
      }

      // Only authenticated users can check for admin roles
      allow get: if isSignedIn();

      // Allow creating and deleting admin users to authenticated users.
      allow create: if isSignedIn();
      allow delete: if isSignedIn();

      // Prevent listing and updating of admin users.
      allow list: if false;
      allow update: if false;
    }
  }
}