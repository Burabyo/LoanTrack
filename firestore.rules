rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures client data. Only admins can create, read, update, or delete client documents.
     * @path /clients/{clientId}
     */
    match /clients/{clientId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Secures loan data under a specific client. Only admins can create, read, update, or delete loan documents.
     * @path /clients/{clientId}/loans/{loanId}
     */
    match /clients/{clientId}/loans/{loanId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Secures payment data under a specific loan of a specific client. Only admins can create, read, update, or delete payment documents.
     * @path /clients/{clientId}/loans/{loanId}/payments/{paymentId}
     */
    match /clients/{clientId}/loans/{loanId}/payments/{paymentId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Secures cash flow transaction data. Only admins can create, read, update, or delete cash flow documents.
     * @path /cash_flow/{cashFlowId}
     */
    match /cash_flow/{cashFlowId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Secures cashier performance data. Only admins can create, read, update, or delete cashier performance documents.
     * @path /cashier_performance/{cashierPerformanceId}
     */
    match /cashier_performance/{cashierPerformanceId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Secures user data. Users can create their own documents. Only admins can update or delete user documents.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

       /**
        * @description Determines admin status based on document existence in the /roles_admin collection.
        * @path /roles_admin/{userId}
        */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is an admin.
  function isAdmin() {
    return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}