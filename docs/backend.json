{
  "entities": {
    "Client": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Client",
      "type": "object",
      "description": "Represents a client who takes loans.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Client entity."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the client."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the client."
        },
        "phoneNumber": {
          "type": "string",
          "description": "Phone number of the client."
        },
        "address": {
          "type": "string",
          "description": "Address of the client."
        },
        "isNewClient": {
          "type": "boolean",
          "description": "Indicates whether the client is new or returning."
        },
        "status": {
          "type": "string",
          "description": "Status of the client (e.g., good, overdue, skipping payments)."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "phoneNumber",
        "address",
        "isNewClient",
        "status"
      ]
    },
    "Loan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Loan",
      "type": "object",
      "description": "Represents a loan issued to a client.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Loan entity."
        },
        "clientId": {
          "type": "string",
          "description": "Reference to Client. (Relationship: Client 1:N Loan)"
        },
        "amount": {
          "type": "number",
          "description": "Amount of the loan issued."
        },
        "interestRate": {
          "type": "number",
          "description": "Interest rate applied to the loan (e.g., 0.20 for 20%)."
        },
        "processingFeeRate": {
          "type": "number",
          "description": "Processing fee rate applied to the loan (e.g., 0.04 for 4%)."
        },
        "issueDate": {
          "type": "string",
          "description": "Date when the loan was issued.",
          "format": "date-time"
        },
        "dueDate": {
          "type": "string",
          "description": "Date when the loan is due.",
          "format": "date-time"
        },
        "totalRepayable": {
          "type": "number",
          "description": "Total amount repayable (principal + interest + fees)."
        }
      },
      "required": [
        "id",
        "clientId",
        "amount",
        "interestRate",
        "processingFeeRate",
        "issueDate",
        "dueDate",
        "totalRepayable"
      ]
    },
    "Payment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payment",
      "type": "object",
      "description": "Represents a payment made by a client towards a loan.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Payment entity."
        },
        "loanId": {
          "type": "string",
          "description": "Reference to Loan. (Relationship: Loan 1:N Payment)"
        },
        "paymentDate": {
          "type": "string",
          "description": "Date when the payment was made.",
          "format": "date-time"
        },
        "amountPaid": {
          "type": "number",
          "description": "Amount paid by the client."
        }
      },
      "required": [
        "id",
        "loanId",
        "paymentDate",
        "amountPaid"
      ]
    },
    "CashFlow": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CashFlow",
      "type": "object",
      "description": "Represents cash flow transactions (in and out).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CashFlow entity."
        },
        "transactionDate": {
          "type": "string",
          "description": "Date of the cash flow transaction.",
          "format": "date-time"
        },
        "description": {
          "type": "string",
          "description": "Description of the cash flow transaction (e.g., lunch, transport, airtime, loan issued, repayment)."
        },
        "amount": {
          "type": "number",
          "description": "Amount of the cash flow transaction.  Positive for cash in, negative for cash out."
        },
        "type": {
          "type": "string",
          "description": "Type of the cashflow transaction (e.g., 'cashIn', 'cashOut', 'expense')."
        }
      },
      "required": [
        "id",
        "transactionDate",
        "description",
        "amount",
        "type"
      ]
    },
    "CashierPerformance": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CashierPerformance",
      "type": "object",
      "description": "Represents the performance data of a cashier.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CashierPerformance entity."
        },
        "cashierId": {
          "type": "string",
          "description": "Reference to the User entity representing the cashier."
        },
        "transactionDate": {
          "type": "string",
          "description": "Date of the transaction.",
          "format": "date-time"
        },
        "transactionType": {
          "type": "string",
          "description": "Type of transaction (e.g., loan issuance, repayment)."
        },
        "amount": {
          "type": "number",
          "description": "Amount of the transaction."
        },
        "notes": {
          "type": "string",
          "description": "Notes generated by the LLM analysis, indicating deviations from average or suspicious patterns."
        }
      },
      "required": [
        "id",
        "cashierId",
        "transactionDate",
        "transactionType",
        "amount",
        "notes"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system (e.g., cashier, manager).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "username": {
          "type": "string",
          "description": "Username of the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "Role of the user (e.g., cashier, manager)."
        }
      },
      "required": [
        "id",
        "username",
        "email",
        "role"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/backend/entities/Client"
          },
          "description": "Stores client information. Each client document is uniquely identified by clientId.",
          "params": [
            {
              "name": "clientId",
              "description": "Unique identifier for the client."
            }
          ]
        }
      },
      {
        "path": "/clients/{clientId}/loans/{loanId}",
        "definition": {
          "entityName": "Loan",
          "schema": {
            "$ref": "#/backend/entities/Loan"
          },
          "description": "Stores loan information for a specific client. Includes denormalized clientId for authorization independence.",
          "params": [
            {
              "name": "clientId",
              "description": "Unique identifier for the client."
            },
            {
              "name": "loanId",
              "description": "Unique identifier for the loan."
            }
          ]
        }
      },
      {
        "path": "/clients/{clientId}/loans/{loanId}/payments/{paymentId}",
        "definition": {
          "entityName": "Payment",
          "schema": {
            "$ref": "#/backend/entities/Payment"
          },
          "description": "Stores payment information for a specific loan of a specific client. Includes denormalized loanId and clientId for authorization independence.",
          "params": [
            {
              "name": "clientId",
              "description": "Unique identifier for the client."
            },
            {
              "name": "loanId",
              "description": "Unique identifier for the loan."
            },
            {
              "name": "paymentId",
              "description": "Unique identifier for the payment."
            }
          ]
        }
      },
      {
        "path": "/cash_flow/{cashFlowId}",
        "definition": {
          "entityName": "CashFlow",
          "schema": {
            "$ref": "#/backend/entities/CashFlow"
          },
          "description": "Stores cash flow transactions.",
          "params": [
            {
              "name": "cashFlowId",
              "description": "Unique identifier for the cash flow transaction."
            }
          ]
        }
      },
      {
        "path": "/cashier_performance/{cashierPerformanceId}",
        "definition": {
          "entityName": "CashierPerformance",
          "schema": {
            "$ref": "#/backend/entities/CashierPerformance"
          },
          "description": "Stores cashier performance data. Includes cashierId for authorization.",
          "params": [
            {
              "name": "cashierPerformanceId",
              "description": "Unique identifier for the cashier performance record."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user information.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection represent admin users. Existence of a document indicates admin role.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the admin user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure Authorization Independence, support QAPs, and maintain data integrity. It leverages path-based ownership for user-related data and denormalization to avoid hierarchical authorization dependencies. The design incorporates structural segregation to maintain homogeneous security postures within collections. The CashierPerformance data utilizes denormalization to include relevant cashier information, enabling secure and efficient data retrieval for performance analysis. Explicit state modeling is encouraged (e.g., client 'status').\n\nAuthorization Independence is achieved by avoiding `get()` calls in security rules. For instance, the `loans` subcollection under each `client` denormalizes client information, allowing loan documents to be created and accessed independently of the parent client document.  Similarly, cashier performance data includes the cashierId, enabling rules to validate access based solely on this denormalized data.  This makes atomic operations possible and simplifies debugging.\n\nQAPs are supported by structural segregation.  Private data (e.g., client loans and payments) are stored under the respective client's document, ensuring that listing loans requires authorization for that specific client.  Global roles are managed through dedicated collections (`roles_admin`), enabling efficient role-based access control without requiring document reads in rules. The structure also allows secure listing operations as each collection maintains a homogeneous security posture. For instance, listing loans under a specific client is secure because all documents in that subcollection share the same security requirements. The use of dedicated collections for roles eliminates filtering requirements in rules, as membership is determined by document existence."
  }
}